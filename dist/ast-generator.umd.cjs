(function(i,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(i=typeof globalThis<"u"?globalThis:i||self,f(i["ast-generator"]={}))})(this,function(i){"use strict";var C=Object.defineProperty;var I=(i,f,w)=>f in i?C(i,f,{enumerable:!0,configurable:!0,writable:!0,value:w}):i[f]=w;var c=(i,f,w)=>I(i,typeof f!="symbol"?f+"":f,w);class f{constructor(e){c(this,"raw","");c(this,"cursor",0);this.raw=e}get current(){return this.raw[this.cursor]}get next(){return this.raw[++this.cursor]}get prev(){return this.raw[--this.cursor]}matches(e){return this.raw.slice(this.cursor,this.cursor+e.length)===e}before(e){return this.raw.slice(this.cursor-e.length,this.cursor)===e}after(e){return this.raw.slice(this.cursor+1,this.cursor+e.length+1)===e}distanceTo(e){const n=this.raw.indexOf(e,this.cursor)-this.cursor-1;return n<0?1/0:n}closest(e){return e.map(n=>[n,this.distanceTo(n)]).sort((n,s)=>n[1]-s[1])}startTransaction(){const{cursor:e}=this;function n(){this.cursor=e}return n.bind(this)}getUntil(e){const n=this.raw.indexOf(e,this.cursor);if(n===-1)return;const s=this.raw.slice(this.cursor,n);return this.cursor+=s.length,s}slice(e){if(e<0)throw new RangeError(`Cannot slice backwards from ${this.cursor} to ${e}.`);const n=this.raw.slice(this.cursor,this.cursor+e);return this.cursor=e===1/0?this.raw.length:this.cursor+e,n}move(e){return this.cursor+=e,this}moveTo(e){return this.cursor=e,this}jumpTo(e){return this.cursor=this.raw.indexOf(e,this.cursor)}consume(e){let n;const s=this.cursor;for(Array.isArray(e)||(e=[e]);(n=e.findIndex(u=>this.matches(u)))>-1;)this.move(e[n].length);return this.raw.slice(s,this.cursor)}}const w=[" ","	",`
`,"\r","\f","\v"," "," "," "," "," "," "," "," "," "," "," "," "," ","\u2028","\u2029"," "," ","　","\uFEFF"],o=Symbol("failed"),a=Symbol("newline"),N=Symbol("endline"),p=Symbol("beginning"),d=Symbol("ending");class b{constructor(){c(this,"idle",!0);c(this,"node",Object.create(null))}name(e){return this.idle=!1,this.node.name=e,this}starts(e){return this.idle=!1,this.node.start=e,this}ends(e){return this.idle=!1,this.node.end=e,this}set(e,n){return this.idle=!1,this.node[e]=n,this}flush(){const{node:e}=this;return this.idle=!0,this.node=Object.create(null),e}shift(e){return this.node.end||(this.node.end=this.node.start||0),this.node.start||(this.node.start=this.node.end||0),this.node.end+=e,this.node.start+=e,this}}class k extends Array{constructor(){super(...arguments);c(this,"checkpointMonitor",[])}appendToLatestTextNode(n,s,u){if(n===void 0)return;const r=this.at(-1);if((r==null?void 0:r.name)==="text")r.value=r.value+n,r.end=r.end+n.length,this.checkpointMonitor.push([r,n]);else{const l=new b().name("text").set("value",n).starts(u+s.cursor).ends(u+s.cursor+n.length-1).flush();this.push(l),this.checkpointMonitor.push([l,s.current])}}createCheckpoint(){const n=this.checkpointMonitor.length;function s(){const u=this.checkpointMonitor.slice(Math.max(n,0));for(const[r,l]of u){const h=r.value.lastIndexOf(l),y=r.value.slice(0,h),S=r.value.slice(h+1);r.value=y+S,r.end-=l.length}this.checkpointMonitor.length=n}return s.bind(this)}}class m{constructor(e,n){c(this,"sequenceName");c(this,"target");c(this,"astNode");c(this,"nodes");c(this,"offset",0);c(this,"cursor");c(this,"scope");c(this,"stream");c(this,"handler");c(this,"sequenceNameOnScope");c(this,"astNodeName");c(this,"result");this.target=e,this.handler=n,this.sequenceName=n.name}run(e){return Object.assign(this,e),this.result=this.handler.call(this,e),this.setupSubNode(),this.setScope(this.result),this.result}setScope(e){return this.sequenceNameOnScope&&(this.scope[this.sequenceNameOnScope]=e),e}setupSubNode(e){if(this.astNodeName&&!(this.astNodeName in this.astNode.node)){e=e||this.target;const n=new b().set("value",e).starts(this.offset+this.cursor).ends(this.offset+this.cursor+e.length-1).flush();this.astNode.set(this.astNodeName,n)}return e}name(e){return this.sequenceNameOnScope=e,this}as(e){if(["start","end","name"].includes(e))throw new ReferenceError(`The name "${e}" is reserved.`);return this.astNodeName=e,this}text(){const e=(()=>{if(this.result===a)return`
`;if(typeof this.result=="string")return this.result})();return e===void 0?this:(this.nodes.appendToLatestTextNode(e,this.stream,this.offset),this)}}class g{constructor(e){c(this,"name");c(this,"sequences");this.name=e}structure(e){return this.sequences=e,this}run({stream:e,nodes:n,offset:s}){if(this.sequences.length===0)return o;const{name:u}=this,r=new b,l=e.startTransaction(),h=n.createCheckpoint(),y={};r.name(u).starts(s+e.cursor);for(const S of this.sequences){const P={scope:y,stream:e,astNode:r,nodes:n,offset:s,cursor:e.cursor};if(S.run(P)===o)return l(),h(),r.flush(),o}return r.ends(Math.max(s+e.cursor-1,r.node.start||0)).flush()}}class v{constructor({components:e=[],offset:n=0}={}){c(this,"components");c(this,"offset");this.components=e,this.offset=n}parse(e){const n=new k,s=new f(e);for(;s.current!==void 0;){let u=!1;for(const r of this.components){const l=s.cursor,h=r.run({stream:s,nodes:n,offset:this.offset});if(h!==o){u=!0,n.push(h),l===s.cursor&&(n.appendToLatestTextNode(s.current,s,this.offset),s.next);break}}u||(n.appendToLatestTextNode(s.current,s,this.offset),s.next)}return n.checkpointMonitor.length=0,n}}function O(t,e){return Object.defineProperty(t,Symbol.toStringTag,{value:e}),t}function A(t,e){return O(new g(t),"comp<"+t+">").structure(e)}function q(t){return new m(t,function({stream:n}){return t===a?n.matches(`
`)||n.cursor===0?o:!0:t===p?n.cursor===0?o:!0:t===d?n.cursor>=n.raw.length-1?o:!0:!n.matches(t)||o})}function T(t){return new m(t,function({stream:n}){if(Array.isArray(t)){for(const s of t){const u=T(s).run(...arguments);if(u!==o)return u}return o}return t===a?n.matches(`
`)?t:o:t===N?n.after(`
`)?t:o:t===p?n.cursor===0?p:o:t===d?n.cursor>=n.raw.length-1?d:o:n.matches(t)||o})}function M(t){return new m(t,function({stream:n,offset:s,nodes:u,astNode:r}){return n.matches(t)?(u.appendToLatestTextNode(t,n,s),n.move(t.length),r.shift(t.length),!0):o})}function x(t){return new m(t,e);function e({stream:n}){if(Array.isArray(t)){for(const s of t)if(x(s).run(...arguments)!==o)return s;return o}if(t===a)return n.matches(`
`)?(n.move(1),t):o;if(t===N){if(n.after(`
`))return n.move(1),t}else{if(t===p)return n.cursor===0?p:o;if(t===d)return n.cursor>=n.raw.length-1?d:o;if(n.matches(t))return n.move(t.length),!0}return o}}function j(t){return new m(t,function({stream:n}){const s=(()=>{if(Array.isArray(t)){let u=function(h){return h===N||h===a?`
`:h===d?n.raw[n.length-1]:h===p?"":Array.isArray(h)?h.map(u):h};const r=t.map(u).flat(),l=n.closest(r);return l.length===0?void 0:n.slice(l[0][1]+1)}else if(t===N||t===a){const u=n.getUntil(`
`);return u===void 0?n.slice(n.raw.length-n.cursor):u}else return t===d?n.slice(n.raw.length-n.cursor):n.getUntil(t)})();return s===void 0?o:this.setupSubNode(s)})}function L(t){return new m(t,function({stream:n}){return this.setupSubNode(n.consume(t))})}i.Parser=v,i.beginning=p,i.component=A,i.consume=L,i.ending=d,i.endline=N,i.exact=x,i.failed=o,i.match=T,i.newline=a,i.not=q,i.space=w,i.text=M,i.until=j,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
